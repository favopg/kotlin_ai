<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kotlin APIサンプル</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container" style="max-width: 960px;">
        <div class="row min-vh-100">
            <!-- 左サイドメニュー（ダーク） -->
            <aside class="col-12 col-md-3 col-lg-2 bg-dark text-white p-3">
                <h5 class="mb-4">メニュー</h5>
                <nav class="nav nav-pills flex-column gap-2">
                    <a class="nav-link text-white bg-secondary" href="index.html">検索</a>
                    <a class="nav-link text-white bg-secondary" href="register.html">登録</a>
                </nav>
            </aside>

            <!-- 右サイド コンテンツ枠 -->
            <main class="col-12 col-md-9 col-lg-10 p-4">
                <div class="card shadow-sm">
                    <div class="card-header">コンテンツ</div>
                    <div id="app" class="card-body">
                        <div v-if="hasData">
                            <!-- 円グラフ（右サイドコンテンツの一番上） -->
                            <div class="mb-4">
                                <h5 class="card-title mb-2">円グラフ</h5>
                                <div class="ratio ratio-1x1" style="max-width: 420px;">
                                    <canvas id="categoryPieChart" aria-label="カテゴリー別支出円グラフ" role="img"></canvas>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-sm table-striped align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col">ID</th>
                                            <th scope="col">カテゴリー</th>
                                            <th scope="col">金額</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="item in items" :key="item.id">
                                            <td><a :href="'#' + item.id">{{ item.id }}</a></td>
                                            <td>{{ item.category }}</td>
                                            <td>{{ formatYen(item.amount) }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div v-else class="alert alert-info mb-0" role="alert">
                            {{ dummyMessage }}
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    items: [],
                    dummyMessage: 'データがありません。登録を行ってください。',
                    _chart: null
                }
            },
            computed: {
                hasData() {
                    return Array.isArray(this.items) && this.items.length > 0;
                }
            },
            methods: {
                parseAmount(val) {
                    if (typeof val === 'number') return val;
                    const n = String(val).replace(/[^\d.-]/g, '');
                    return Number(n || 0);
                },
                formatYen(val) {
                    const num = this.parseAmount(val);
                    return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(num);
                },
                buildChart() {
                    if (!this.hasData) return;
                    const totals = {};
                    for (const it of this.items) {
                        totals[it.category] = (totals[it.category] || 0) + this.parseAmount(it.amount);
                    }
                    const labels = Object.keys(totals);
                    const data = Object.values(totals);
                    const ctx = document.getElementById('categoryPieChart');
                    if (!ctx) return;
                    if (this._chart) {
                        this._chart.destroy();
                    }
                    this._chart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels,
                            datasets: [{
                                data,
                                backgroundColor: ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc948','#b07aa1','#ff9da7','#9c755f','#bab0ab'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            plugins: {
                                legend: { position: 'bottom' },
                                title: { display: true, text: 'カテゴリー別支出' }
                            }
                        }
                    });
                },
                async fetchInit() {
                    try {
                        const res = await fetch('/expense/init', { headers: { 'Accept': 'application/json' } });
                        if (!res.ok) {
                            console.error('Failed to fetch /expense/init', res.status);
                            this.items = [];
                            return;
                        }
                        const data = await res.json();
                        if (!Array.isArray(data) || data.length === 0) {
                            this.items = [];
                        } else {
                            // Map backend {category, money} => {id, category, amount}
                            this.items = data.map((row, idx) => ({
                                id: idx + 1,
                                category: row.category ?? row.Category ?? '未分類',
                                amount: typeof row.money === 'number' ? row.money : Number(row.money || 0)
                            }));
                        }
                        // Build chart if data exists
                        this.$nextTick(() => this.buildChart());
                    } catch (e) {
                        console.error('Error fetching /expense/init', e);
                        this.items = [];
                    }
                }
            },
            mounted() {
                this.fetchInit();
            }
        }).mount('#app');
    </script>
</body>
</html>
