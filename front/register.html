<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>登録 - Kotlin APIサンプル</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container" style="max-width: 960px;">
        <div class="row min-vh-100">
            <!-- 左サイドメニュー（ダーク） -->
            <aside class="col-12 col-md-3 col-lg-2 bg-dark text-white p-3">
                <h5 class="mb-4">メニュー</h5>
                <nav class="nav nav-pills flex-column gap-2">
                    <a class="nav-link text-white bg-secondary" href="index.html">検索</a>
                    <a class="nav-link text-white bg-secondary" href="register.html">登録</a>
                </nav>
            </aside>

            <!-- 右サイド コンテンツ枠（Vue.jsで実装） -->
            <main class="col-12 col-md-9 col-lg-10 p-4">
                <div class="card shadow-sm">
                    <div class="card-header">コンテンツ</div>
                    <div id="app" class="card-body">
                        <h5 class="card-title mb-3">登録フォーム</h5>

                        <!-- 成功メッセージ -->
                        <div v-if="successMessage" class="alert alert-success" role="alert">
                            {{ successMessage }}
                        </div>
                        <!-- エラーメッセージ -->
                        <div v-if="errorMessage" class="alert alert-danger" role="alert">
                            {{ errorMessage }}
                        </div>

                        <form @submit.prevent="submitForm">
                            <div class="row g-3">
                                <div class="col-sm-6">
                                    <label for="inputCategory" class="form-label">カテゴリー</label>
                                    <select id="inputCategory" class="form-select" v-model="form.category" required>
                                        <option disabled value="">選択...</option>
                                        <option>食費</option>
                                        <option>交通</option>
                                        <option>住居</option>
                                        <option>光熱費</option>
                                        <option>娯楽</option>
                                        <option>教育</option>
                                        <option>医療</option>
                                        <option>日用品</option>
                                        <option>通信</option>
                                        <option>その他</option>
                                    </select>
                                </div>
                                <div class="col-sm-6">
                                    <label for="inputAmount" class="form-label">金額</label>
                                    <div class="input-group">
                                        <span class="input-group-text">¥</span>
                                        <input type="number" min="0" step="1" class="form-control" id="inputAmount" placeholder="0" v-model.number="form.amount" required>
                                    </div>
                                </div>
                            </div>
                            <!-- CSRF hidden token for semantic form completeness (Double Submit Cookie uses cookie + header) -->
                            <input type="hidden" name="_csrf" :value="csrfToken">
                            <div class="mt-4 d-flex gap-2">
                                <button type="submit" class="btn btn-primary" :disabled="loading">
                                    <span v-if="loading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                    登録
                                </button>
                                <button type="button" class="btn btn-outline-secondary" @click="resetForm" :disabled="loading">リセット</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    form: {
                        category: '',
                        amount: null
                    },
                    loading: false,
                    successMessage: '',
                    errorMessage: '',
                    csrfToken: ''
                }
            },
            mounted() {
                // 初回マウント時にCSRFトークンを取得（Cookieに設定される）
                fetch('/csrf/token', { credentials: 'same-origin' })
                    .then(() => {
                        this.csrfToken = this.getCookie('XSRF-TOKEN') || '';
                    })
                    .catch(() => {
                        // 無視（サーバ停止時など）。送信時に検出される
                    });
            },
            methods: {
                getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                    return '';
                },
                async submitForm() {
                    this.successMessage = '';
                    this.errorMessage = '';

                    // 入力バリデーション（簡易）
                    if (!this.form.category || this.form.amount === null || this.form.amount === '' || isNaN(this.form.amount)) {
                        this.errorMessage = 'カテゴリーと金額を入力してください。';
                        return;
                    }

                    this.loading = true;
                    try {
                        const res = await fetch('/expense/register', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-XSRF-TOKEN': this.csrfToken || this.getCookie('XSRF-TOKEN') || ''
                            },
                            body: JSON.stringify({
                                category: this.form.category,
                                amount: this.form.amount
                            })
                        });

                        if (res.ok) {
                            this.successMessage = '登録が完了しました';
                            this.resetForm();
                        } else {
                            const text = await res.text();
                            this.errorMessage = text || `エラーが発生しました (HTTP ${res.status})`;
                        }
                    } catch (e) {
                        this.errorMessage = '通信に失敗しました。サーバーが起動しているか確認してください。';
                    } finally {
                        this.loading = false;
                    }
                },
                resetForm() {
                    this.form.category = '';
                    this.form.amount = null;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
